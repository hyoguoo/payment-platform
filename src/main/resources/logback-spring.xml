<configuration>
  <property name="LOG_PATTERN" value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] [traceId:%X{traceId:-N/A}] %-5level %logger{36} - %msg%n"/>
  <property name="LOG_PATTERN_COLOR"
    value="%d{HH:mm:ss.SSS} [%thread] [%magenta(traceId:%X{traceId:-N/A})] %highlight(%-5level) %cyan(%logger{36}) - %msg%n"/>

  <!-- Spring Properties -->
  <springProperty scope="context" name="springAppName" source="spring.application.name"/>

  <!-- Conversion Rules -->
  <conversionRule conversionWord="clr" converterClass="org.springframework.boot.logging.logback.ColorConverter"/>
  <conversionRule conversionWord="wEx"
    converterClass="org.springframework.boot.logging.logback.WhitespaceThrowableProxyConverter"/>

  <!-- Console Appender (All Profiles) -->
  <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
    <encoder>
      <pattern>${LOG_PATTERN_COLOR}</pattern>
    </encoder>
  </appender>

  <!-- Logstash Appender (Docker Profile) -->
  <springProfile name="docker">
    <appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">
      <destination>logstash:5050</destination>
      <encoder class="net.logstash.logback.encoder.LogstashEncoder">
        <customFields>{"application":"${springAppName:-payment-platform}","environment":"docker"}</customFields>
        <!-- Include all MDC fields (traceId, orderId, paymentKey, userId, etc.) -->
        <includeMdc>true</includeMdc>
      </encoder>
      <keepAliveDuration>5 minutes</keepAliveDuration>
      <reconnectionDelay>10 seconds</reconnectionDelay>
    </appender>

    <!-- File Appender (JSON format for Logstash) -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
      <file>/var/log/app/payment-platform.log</file>
      <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
        <fileNamePattern>/var/log/app/payment-platform.%d{yyyy-MM-dd}.log</fileNamePattern>
        <maxHistory>30</maxHistory>
      </rollingPolicy>
      <encoder class="net.logstash.logback.encoder.LogstashEncoder">
        <customFields>{"application":"${springAppName:-payment-platform}","environment":"docker"}</customFields>
        <includeMdc>true</includeMdc>
      </encoder>
    </appender>
  </springProfile>

  <!-- Root Logger Configuration -->
  <springProfile name="test">
    <root level="INFO">
      <appender-ref ref="CONSOLE"/>
    </root>
    <logger name="com.hyoguoo.paymentplatform" level="DEBUG"/>
    <logger name="org.springframework.web" level="INFO"/>
    <logger name="org.hibernate.SQL" level="DEBUG"/>
  </springProfile>

  <springProfile name="docker">
    <root level="INFO">
      <appender-ref ref="CONSOLE"/>
      <appender-ref ref="FILE"/>
      <appender-ref ref="LOGSTASH"/>
    </root>
    <logger name="com.hyoguoo.paymentplatform" level="INFO"/>
    <logger name="org.springframework.web" level="INFO"/>
    <logger name="org.hibernate.SQL" level="WARN"/>
  </springProfile>

  <!-- Default Profile -->
  <springProfile name="default">
    <root level="INFO">
      <appender-ref ref="CONSOLE"/>
    </root>
  </springProfile>
</configuration>
